<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urdu Content Generator V2.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Nastaliq+Urdu&display=swap" rel="stylesheet">
    
    <style>
        /* Base styles */
        body { font-family: 'Inter', sans-serif; }
        .urdu-text { font-family: 'Noto Nastaliq Urdu', serif; font-size: 1.2rem; vertical-align: middle; }
        .modal { z-index: 1000; }

        /* Sidebar styles */
        #sidebar { transition: width 0.3s ease-in-out; }
        .sidebar-icon { font-size: 1.25rem; }
        .active-nav { background-color: #E5E7EB; color: #1F2937; }
        .sidebar-collapsed { width: 4rem !important; }
        .sidebar-collapsed .sidebar-text { display: none; }
        .sidebar-collapsed .sidebar-icon { margin: auto; }
        .sidebar-collapsed #sidebar-toggle-btn i { transform: rotate(180deg); }

        /* Custom Button styles */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid transparent;
            font-size: 0.875rem;
            cursor: pointer;
        }
        .btn:disabled { background-color: #d1d5db; cursor: not-allowed; }
        .btn-primary { background-color: #0d9488; color: white; border-color: #0d9488;}
        .btn-primary:hover:not(:disabled) { background-color: #0f766e; border-color: #0f766e;}
        .btn-secondary { background-color: #e5e7eb; color: #374151; border-color: #d1d5db;}
        .btn-secondary:hover:not(:disabled) { background-color: #d1d5db; }
        .btn-green { background-color: #16a34a; color: white; border-color: #16a34a;}
        .btn-green:hover:not(:disabled) { background-color: #15803d; border-color: #15803d;}
        .btn-blue { background-color: #2563eb; color: white; border-color: #2563eb;}
        .btn-blue:hover:not(:disabled) { background-color: #1d4ed8; border-color: #1d4ed8;}

        /* Library Table specific styles */
        .sticky-col {
            position: -webkit-sticky; /* for Safari */
            position: sticky;
            right: 0;
            background-color: white;
        }
        .table-container {
            width: 100%;
            overflow-x: auto;
        }
        .table-container thead th {
             background-color: #f9fafb; /* bg-gray-50 */
        }
        .sticky-col {
            background-color: #f9fafb; /* Match header on sticky */
        }
        .hover\:bg-gray-50:hover .sticky-col {
            background-color: #f9fafb; /* Keep sticky col color on row hover */
        }
        tr.bg-white .sticky-col {
            background-color: white; /* Match row color */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Global Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[2000]">
        <i class="fas fa-spinner fa-spin text-teal-600 text-5xl"></i>
        <p id="loading-message" class="mt-4 text-lg text-gray-700">Initializing Application...</p>
    </div>

    <!-- Firebase Setup Modal -->
    <div id="firebase-setup-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-[3000] p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg">
            <h2 class="text-xl font-bold mb-4">Firebase Configuration Required</h2>
            <p class="text-gray-600 mb-4">To run this application, you need to provide your Firebase project's configuration.</p>
            <ol class="list-decimal list-inside text-gray-600 mb-6 space-y-2">
                <li>Go to your Firebase project, then click the gear icon for <strong>Project settings</strong>.</li>
                <li>Under "Your apps", find your web app and click the gear icon for <strong>Config</strong>.</li>
                <li>Copy the entire `firebaseConfig` object and paste it below.</li>
            </ol>
            <textarea id="firebase-config-input" rows="10" class="w-full p-3 border rounded-lg font-mono text-sm" placeholder="const firebaseConfig = { ... };"></textarea>
            <p id="firebase-config-error" class="text-red-500 text-sm mt-2 hidden"></p>
            <div class="flex justify-end mt-4">
                <button id="save-firebase-config" class="btn btn-primary">Save and Initialize</button>
            </div>
        </div>
    </div>

    <!-- Main App Container (Initially Hidden) -->
    <div id="app-container" class="flex h-screen hidden">
        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="w-64 bg-white border-r flex flex-col">
            <div class="h-16 flex items-center justify-center border-b relative px-4">
                <i class="fas fa-book-open-reader text-2xl text-teal-600"></i>
                <span class="sidebar-text ml-3 text-lg font-bold">Urdu Assistant</span>
                <button id="sidebar-toggle-btn" class="absolute right-0 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-gray-100 hidden md:block">
                    <i class="fas fa-chevron-left text-gray-500 transition-transform duration-300"></i>
                </button>
            </div>
            <nav class="flex-1 px-4 py-4 space-y-2">
                <a href="#generate" class="flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-100 nav-link active-nav">
                    <i class="fas fa-magic-sparkles sidebar-icon text-teal-600"></i><span class="sidebar-text ml-4 font-medium">Generate Content</span>
                </a>
                <a href="#library" class="flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-100 nav-link">
                    <i class="fas fa-layer-group sidebar-icon"></i><span class="sidebar-text ml-4 font-medium">My Library</span>
                </a>
            </nav>
            <div class="px-4 py-4 border-t">
                 <div id="auth-container" class="space-y-2"></div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            <div id="generate" class="page-content"></div>
            <div id="library" class="page-content hidden"></div>
        </main>
    </div>

    <!-- MODALS (All hidden by default) -->
    <div id="confirmation-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4"></div>
    <div id="message-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4"></div>
    <div id="add-item-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4"></div>

<script type="module">
    // =================================================================================
    // FIREBASE & APP INITIALIZATION
    // =================================================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- App State ---
    let app, db, auth;
    let currentUserId = null;
    let unsubscribeLibraryListener = null;
    let libraryData = [], generatedContentCache = [];
    let confirmationCallback = null;
    let activeFilters = { type: [], batchName: [], masteryLevel: [] };

    // --- Constants ---
    const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const MASTERY_LEVELS = ['New', 'Familiar', 'Almost', 'Mastered'];
    const CONTENT_TYPES = {
        vocabulary: 'Vocab',
        dialogue: 'Sentence',
        grammar: 'Grammar'
    };

    // =================================================================================
    // CORE APP STARTUP SEQUENCE
    // =================================================================================
    document.addEventListener('DOMContentLoaded', () => {
        // This function sets up Firebase and continues app startup.
        const initializeAndStart = async (config) => {
            try {
                app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);
                await continueAppStartup();
            } catch (error) {
                document.getElementById('loading-message').textContent = `Firebase Error: ${error.message}`;
                document.getElementById('loading-message').classList.add('text-red-600');
                console.error("Firebase initialization failed:", error);
                // If init fails with a stored config, clear it and show modal
                localStorage.removeItem('firebaseConfig');
                document.getElementById('firebase-setup-modal').classList.replace('hidden', 'flex');
            }
        };

        // Check if running in dev environment with injected config
        if (typeof __firebase_config !== 'undefined') {
            initializeAndStart(JSON.parse(__firebase_config));
        } else {
            // Running in production, check local storage
            const savedConfigStr = localStorage.getItem('firebaseConfig');
            if (savedConfigStr) {
                initializeAndStart(JSON.parse(savedConfigStr));
            } else {
                // No config found, show the setup modal
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('firebase-setup-modal').classList.replace('hidden', 'flex');
            }
        }

        // Add event listener for the setup modal's save button
        document.getElementById('save-firebase-config').addEventListener('click', async () => {
            const configInput = document.getElementById('firebase-config-input').value;
            const errorEl = document.getElementById('firebase-config-error');
            try {
                // Handle if user pastes `const firebaseConfig = {..}` or just `{...}`
                const jsonString = configInput.includes('=') ? configInput.split('=')[1].trim().replace(/;$/, '') : configInput;
                const config = JSON.parse(jsonString);

                if (!config.apiKey || !config.authDomain || !config.projectId) {
                    throw new Error("Invalid config: apiKey, authDomain, and projectId are required.");
                }

                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                document.getElementById('firebase-setup-modal').classList.replace('flex', 'hidden');
                document.getElementById('loading-overlay').classList.remove('hidden');
                
                await initializeAndStart(config);

            } catch (e) {
                errorEl.textContent = 'Invalid Firebase Config. Please paste the entire object. Error: ' + e.message;
                errorEl.classList.remove('hidden');
            }
        });
    });

    async function continueAppStartup() {
        const loadingMessage = document.getElementById('loading-message');
        try {
            loadingMessage.textContent = 'Authenticating user...';
            await authenticateUser();
            if (!currentUserId) throw new Error("Authentication failed, user ID is null.");

            loadingMessage.textContent = 'Loading learning data...';
            await setupFirestoreListener();

            loadingMessage.textContent = 'Finalizing...';
            renderFullApp();
            
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');

            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    currentUserId = null;
                    if (unsubscribeLibraryListener) unsubscribeLibraryListener();
                    renderAuthUI();
                    showPage('generate');
                } else if (user.uid !== currentUserId) {
                    currentUserId = user.uid;
                    renderAuthUI();
                    setupFirestoreListener();
                }
            });
        } catch (error) {
            console.error("APP STARTUP FAILED:", error);
            loadingMessage.textContent = `Error: ${error.message}. Please refresh.`;
            loadingMessage.classList.add('text-red-600');
        }
    }


    async function authenticateUser() {
        // Use custom token if available (dev environment), otherwise sign in anonymously
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        try {
            if (initialToken) {
                await signInWithCustomToken(auth, initialToken);
            } else {
                // In production, we'll always sign in anonymously by default
                await signInAnonymously(auth);
            }
            currentUserId = auth.currentUser.uid;
        } catch (authError) {
            console.error("Authentication error:", authError);
            // Attempt one more time with anonymous as a final fallback
            if (!auth.currentUser) {
                 await signInAnonymously(auth);
                 currentUserId = auth.currentUser.uid;
            }
        }
    }

    // =================================================================================
    // UI RENDERING & STRUCTURE
    // =================================================================================
    function renderFullApp() {
        renderGeneratePage();
        renderModalStructures();
        renderAuthUI();
        showPage('generate');
        setupGlobalEventListeners();
    }

    function showPage(pageId) {
        document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
        document.getElementById(pageId)?.classList.remove('hidden');

        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.toggle('active-nav', link.getAttribute('href') === `#${pageId}`);
        });

        if (!currentUserId) {
            const signedOutMessage = `<div class="text-center p-10"><i class="fas fa-lock text-3xl text-gray-400 mb-4"></i><h3 class="font-semibold">Please sign in</h3><p class="text-gray-500">You need to be signed in to access this content.</p></div>`;
            if(pageId === 'library') document.getElementById('library').innerHTML = signedOutMessage;
            return;
        }

        if (pageId === 'library') renderLibrary();
    }
    
    function renderGeneratePage() {
        document.getElementById('generate').innerHTML = `
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Generate New Content</h1>
            <p class="text-gray-600 mb-8">Use the power of AI to create custom learning materials.</p>
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <textarea id="prompt-input" rows="5" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="e.g., 'Give me 10 words about kitchen items with phonetic notes'"></textarea>
                <div class="flex flex-wrap items-center justify-between mt-4 gap-4">
                    <div class="flex gap-2">
                        <button id="generate-btn" class="btn btn-primary"><i class="fas fa-magic-sparkles mr-2"></i>Generate</button>
                        <button id="lucky-btn" class="btn btn-secondary"><i class="fas fa-dice mr-2"></i>I'm Feeling Lucky</button>
                    </div>
                </div>
                <div id="generation-loading" class="hidden mt-6 flex items-center justify-center"><i class="fas fa-spinner fa-spin text-teal-600 text-3xl"></i><span class="ml-3 text-gray-600">Generating...</span></div>
                <div id="generation-output" class="hidden mt-6 p-4 border-l-4 border-teal-500 bg-teal-50"></div>
                <div id="generation-actions" class="hidden mt-4 flex flex-wrap gap-2">
                    <button id="save-to-library-btn" class="btn btn-green text-sm"><i class="fas fa-save mr-2"></i>Save to Library</button>
                    <button id="export-generated-btn" class="btn btn-blue text-sm"><i class="fas fa-file-export mr-2"></i>Export to Quizlet</button>
                </div>
            </div>`;
    }

    function renderModalStructures() {
        document.getElementById('confirmation-modal').innerHTML = `
            <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md text-center relative">
                <h2 id="confirmation-title" class="text-xl font-bold mb-4"></h2>
                <div id="confirmation-body" class="text-gray-700 mb-6 min-h-[2rem]"></div>
                <div class="flex justify-center gap-4">
                    <button id="confirm-yes" class="btn btn-primary">Yes</button>
                    <button id="confirm-no" class="btn btn-secondary">No</button>
                </div>
            </div>`;
        document.getElementById('message-modal').innerHTML = `
            <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm text-center relative">
                <h2 id="message-title" class="text-xl font-bold mb-4"></h2>
                <p id="message-content" class="text-gray-700 mb-6 min-h-[2rem]"></p>
                <button id="close-message-modal" class="btn btn-primary">OK</button>
            </div>`;
        document.getElementById('add-item-modal').innerHTML = `
            <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg">
                <h2 class="text-xl font-bold mb-6">Add New Custom Item</h2>
                <form id="add-item-form" class="space-y-4">
                    <input type="text" name="englishTranslation" class="w-full p-2 border rounded-lg" placeholder="English Translation" required>
                    <input type="text" name="urduScriptTransliteration" class="w-full p-2 border rounded-lg urdu-text" placeholder="Urdu Script & Transliteration" required>
                    <input type="text" name="phoneticHints" class="w-full p-2 border rounded-lg" placeholder="Phonetic Hints">
                    <input type="text" name="notes" class="w-full p-2 border rounded-lg" placeholder="Grammar/Context Notes">
                    <input type="text" name="batchName" class="w-full p-2 border rounded-lg" placeholder="Batch Name" value="Custom" required>
                    <select name="type" class="w-full p-2 border rounded-lg">
                        <option value="vocabulary">Vocabulary</option>
                        <option value="dialogue">Sentence</option>
                        <option value="grammar">Grammar</option>
                    </select>
                    <div class="flex justify-end gap-4 pt-4">
                         <button type="button" id="cancel-add-item" class="btn btn-secondary">Cancel</button>
                         <button type="submit" class="btn btn-primary">Add Item</button>
                    </div>
                </form>
            </div>`;
    }

    // =================================================================================
    // EVENT LISTENERS
    // =================================================================================
    function setupGlobalEventListeners() {
        // --- Navigation ---
        document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => {
            e.preventDefault();
            showPage(e.currentTarget.getAttribute('href').substring(1));
        }));
        document.getElementById('sidebar-toggle-btn').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('sidebar-collapsed');
        });
        
        // --- Modal Buttons ---
        document.getElementById('confirm-yes').addEventListener('click', handleConfirmYes);
        document.getElementById('confirm-no').addEventListener('click', () => closeConfirmationModal());
        document.getElementById('close-message-modal').addEventListener('click', () => hideModal('message-modal'));

        // --- Page-specific listeners (delegated from main content area) ---
        const mainContent = document.querySelector('main');
        mainContent.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            // Generate Page
            if (target.id === 'generate-btn') handleGenerateContent();
            if (target.id === 'lucky-btn') handleImFeelingLucky();
            if (target.id === 'save-to-library-btn') handleSaveToLibrary();
            if (target.id === 'export-generated-btn') exportGeneratedToQuizlet();
            
            // Library Page
            if (target.id === 'add-custom-item-btn') showAddItemModal();
            if (target.id === 'export-library-btn') exportLibraryToQuizlet();
            if (target.classList.contains('delete-item-btn')) {
                const id = target.dataset.id;
                showConfirmationModal('Delete Item?', '<p>This action cannot be undone.</p>', () => deleteItem(id));
            }
        });

        // --- Add Item Modal Form ---
        document.getElementById('add-item-form').addEventListener('submit', handleAddCustomItem);
        document.getElementById('cancel-add-item').addEventListener('click', () => hideModal('add-item-modal'));
    }
    
    // =================================================================================
    // FIRESTORE & DATA HANDLING
    // =================================================================================
    function setupFirestoreListener() {
        if (unsubscribeLibraryListener) unsubscribeLibraryListener(); // Unsubscribe from previous listener
        if (!db || !currentUserId) return Promise.resolve();

        const collectionRef = collection(db, `/artifacts/${APP_ID}/users/${currentUserId}/library`);
        
        return new Promise((resolve, reject) => {
            unsubscribeLibraryListener = onSnapshot(collectionRef, (snapshot) => {
                libraryData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const visiblePage = document.querySelector('.page-content:not(.hidden)');
                if (visiblePage && visiblePage.id === 'library') {
                    renderLibraryContent(); // Re-render if library is visible
                }
                resolve();
            }, (error) => {
                console.error("Error listening to library:", error);
                showMessageModal('Sync Error', 'Could not sync with your library.');
                reject(error);
            });
        });
    }

    async function updateItem(itemId, dataToUpdate) {
        if (!currentUserId) return showMessageModal('Error', 'Not authenticated.');
        const itemRef = doc(db, `/artifacts/${APP_ID}/users/${currentUserId}/library`, itemId);
        try {
            await updateDoc(itemRef, dataToUpdate);
        } catch(e) {
            console.error("Update failed:", e);
            showMessageModal('Error', 'Failed to save changes.');
        }
    }

    async function deleteItem(itemId) {
        if (!currentUserId) return showMessageModal('Error', 'Not authenticated.');
        const itemRef = doc(db, `/artifacts/${APP_ID}/users/${currentUserId}/library`, itemId);
        await deleteDoc(itemRef);
        showMessageModal('Success', 'Item deleted from your library.');
    }

    async function addContentToFirestore(contentArray, batchName, type) {
        if (!currentUserId) return showMessageModal('Error', 'User not authenticated.');
        const collectionRef = collection(db, `/artifacts/${APP_ID}/users/${currentUserId}/library`);
        const batch = writeBatch(db);
        
        let addedCount = 0, skippedCount = 0;
        for (const item of contentArray) {
            const normalizedEnglish = (item.englishTranslation || '').toLowerCase().trim();
            // Check against local cache first to prevent duplicate Firestore reads
            const isDuplicate = libraryData.some(libItem => 
                (libItem.normalizedEnglish || '').toLowerCase().trim() === normalizedEnglish
            );

            if (!isDuplicate) {
                const newDocRef = doc(collectionRef);
                batch.set(newDocRef, { 
                    ...item, 
                    type, 
                    batchName: batchName || 'Generated', 
                    masteryLevel: 'New', 
                    createdAt: new Date(), 
                    normalizedEnglish 
                });
                addedCount++;
            } else {
                skippedCount++;
            }
        }
        
        if (addedCount > 0) await batch.commit();
        
        showMessageModal('Content Saved', `Added ${addedCount} new items. Skipped ${skippedCount} duplicates.`);
        document.getElementById('generation-output').classList.add('hidden');
        document.getElementById('generation-actions').classList.add('hidden');
    }
    
    // =================================================================================
    // LIBRARY & CONTENT RENDERING
    // =================================================================================
    function renderLibrary() {
        document.getElementById('library').innerHTML = `
            <h1 class="text-3xl font-bold text-gray-800 mb-2">My Library</h1>
            <p class="text-gray-600 mb-6">Curate, practice, and export your personalized learning sets.</p>
            <div id="library-content-area" class="mt-6"></div>`;
        renderLibraryContent();
    }

    function renderLibraryContent() {
        const contentArea = document.getElementById('library-content-area');
        if (!contentArea) return;

        const headers = ['English', 'Urdu', 'Phonetics', 'Notes', 'Batch', 'Mastery', 'Type', 'Actions'];
        
        const filteredData = libraryData.filter(item => 
            (activeFilters.type.length === 0 || activeFilters.type.includes(item.type)) &&
            (activeFilters.batchName.length === 0 || activeFilters.batchName.includes(item.batchName)) &&
            (activeFilters.masteryLevel.length === 0 || activeFilters.masteryLevel.includes(item.masteryLevel))
        );

        const allTypes = [...new Set(libraryData.map(i => i.type))];
        const allBatches = [...new Set(libraryData.map(i => i.batchName))];

        contentArea.innerHTML = `
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <div class="flex flex-wrap gap-4 mb-4 items-center">
                    ${renderMultiSelectFilter('type', 'Filter by Type', allTypes, activeFilters.type)}
                    ${renderMultiSelectFilter('batchName', 'Filter by Batch', allBatches, activeFilters.batchName)}
                    ${renderMultiSelectFilter('masteryLevel', 'Filter by Mastery', MASTERY_LEVELS, activeFilters.masteryLevel)}
                    <div class="ml-auto flex gap-2">
                        <button id="add-custom-item-btn" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Add Custom</button>
                        <button id="export-library-btn" class="btn btn-blue"><i class="fas fa-file-export mr-2"></i>Export Selected</button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-6 py-3"><input type="checkbox" id="select-all-items"></th>
                                ${headers.map(h => `<th scope="col" class="px-6 py-3 ${h === 'Actions' ? 'sticky-col' : ''}">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody id="library-table-body">
                            ${filteredData.map(item => `
                                <tr class="bg-white border-b hover:bg-gray-50" data-id="${item.id}">
                                    <td class="px-6 py-4"><input type="checkbox" class="item-select-checkbox" data-id="${item.id}"></td>
                                    <td class="px-6 py-4" contenteditable="true" data-field="englishTranslation">${item.englishTranslation || ''}</td>
                                    <td class="px-6 py-4 urdu-text" contenteditable="true" data-field="urduScriptTransliteration">${item.urduScriptTransliteration || ''}</td>
                                    <td class="px-6 py-4" contenteditable="true" data-field="phoneticHints">${item.phoneticHints || ''}</td>
                                    <td class="px-6 py-4" contenteditable="true" data-field="notes">${(item.grammarNotes || '') + ' ' + (item.contextualUsageNotes || '')}</td>
                                    <td class="px-6 py-4" contenteditable="true" data-field="batchName">${item.batchName || ''}</td>
                                    <td class="px-6 py-4">
                                        <select class="mastery-select border rounded-lg p-1 bg-white" data-id="${item.id}">${MASTERY_LEVELS.map(level => `<option value="${level}" ${item.masteryLevel === level ? 'selected' : ''}>${level}</option>`).join('')}</select>
                                    </td>
                                    <td class="px-6 py-4"><span class="font-semibold">${CONTENT_TYPES[item.type] || item.type}</span></td>
                                    <td class="px-6 py-4 sticky-col">
                                        <button class="delete-item-btn text-red-500 hover:text-red-700 p-1" data-id="${item.id}"><i class="fas fa-trash-alt"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                            ${filteredData.length === 0 ? `<tr><td colspan="${headers.length + 1}" class="text-center py-8">No items match the current filters.</td></tr>` : ''}
                        </tbody>
                    </table>
                </div>
            </div>`;
        
        setupLibraryTableEventListeners();
    }

    function renderMultiSelectFilter(key, label, options, selected) {
        return `
            <div class="relative">
                <label for="filter-${key}" class="block text-sm font-medium text-gray-700">${label}</label>
                <select id="filter-${key}" multiple class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md">
                    ${options.map(opt => `<option value="${opt}" ${selected.includes(opt) ? 'selected' : ''}>${CONTENT_TYPES[opt] || opt}</option>`).join('')}
                </select>
            </div>`;
    }

    function setupLibraryTableEventListeners() {
        // --- Filter Listeners ---
        ['type', 'batchName', 'masteryLevel'].forEach(key => {
            const select = document.getElementById(`filter-${key}`);
            if (select) {
                select.addEventListener('change', () => {
                    activeFilters[key] = Array.from(select.selectedOptions).map(opt => opt.value);
                    renderLibraryContent();
                });
            }
        });

        // --- Select All Checkbox ---
        const selectAllCheckbox = document.getElementById('select-all-items');
        selectAllCheckbox?.addEventListener('change', (e) => {
            document.querySelectorAll('.item-select-checkbox').forEach(cb => cb.checked = e.target.checked);
        });

        // --- Inline Editing & Mastery Select ---
        const tableBody = document.getElementById('library-table-body');
        if (!tableBody) return;

        // For contenteditable cells
        tableBody.addEventListener('blur', (e) => {
            if (e.target.hasAttribute('contenteditable')) {
                const id = e.target.closest('tr').dataset.id;
                const field = e.target.dataset.field;
                const value = e.target.textContent;
                const originalItem = libraryData.find(item => item.id === id);
                if (originalItem && originalItem[field] !== value) {
                    const updateData = { [field]: value };
                    // Also update normalizedEnglish if englishTranslation is changed
                    if (field === 'englishTranslation') {
                        updateData.normalizedEnglish = value.toLowerCase().trim();
                    }
                    updateItem(id, updateData);
                }
            }
        }, true); // Use capture phase to ensure blur event is caught

        // For mastery select dropdown
        tableBody.addEventListener('change', (e) => {
            if (e.target.classList.contains('mastery-select')) {
                const id = e.target.dataset.id;
                const value = e.target.value;
                updateItem(id, { masteryLevel: value });
            }
        });
    }

    // =================================================================================
    // AUTHENTICATION UI
    // =================================================================================
    function renderAuthUI() {
        const container = document.getElementById('auth-container');
        if (!container) return;
        if (currentUserId && auth.currentUser && !auth.currentUser.isAnonymous) {
            container.innerHTML = `<p class="text-sm text-gray-500 truncate">Signed in as: ${auth.currentUser.email}</p><button id="sign-out-btn" class="btn btn-secondary w-full mt-2">Sign Out</button>`;
            document.getElementById('sign-out-btn').addEventListener('click', () => signOut(auth));
        } else {
             container.innerHTML = `<p class="text-sm text-gray-500">Signed in anonymously.</p>`;
        }
    }

    // =================================================================================
    // MODALS
    // =================================================================================
    function showModal(modalId) { document.getElementById(modalId)?.classList.replace('hidden', 'flex'); }
    function hideModal(modalId) { document.getElementById(modalId)?.classList.replace('flex', 'hidden'); }
    function showMessageModal(title, message) {
        document.getElementById('message-title').textContent = title;
        document.getElementById('message-content').textContent = message;
        showModal('message-modal');
    }
    function showConfirmationModal(title, bodyHtml, callback) {
        confirmationCallback = callback;
        document.getElementById('confirmation-title').textContent = title;
        document.getElementById('confirmation-body').innerHTML = bodyHtml;
        showModal('confirmation-modal');
    }
    
    function handleConfirmYes() {
        if (typeof confirmationCallback === 'function') {
            const batchNameInput = document.getElementById('batch-name-input');
            const typeSelect = document.getElementById('content-type-select');

            if (batchNameInput && typeSelect) { // Specific case for saving to library
                const batchName = batchNameInput.value.trim();
                const type = typeSelect.value;
                if (!batchName) {
                    showMessageModal('Input Required', 'Please enter a Batch Name.');
                    return; // Don't close the confirmation modal yet
                }
                confirmationCallback({ batchName, type });
            } else {
                confirmationCallback(true); // Generic confirmation
            }
        }
        closeConfirmationModal();
    }

    function closeConfirmationModal() {
        confirmationCallback = null;
        hideModal('confirmation-modal');
    }
    
    function showAddItemModal() {
        document.getElementById('add-item-form').reset();
        showModal('add-item-modal');
    }
    
    async function handleAddCustomItem(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const newItem = Object.fromEntries(formData.entries());
        
        newItem.normalizedEnglish = (newItem.englishTranslation || '').toLowerCase().trim();
        newItem.createdAt = new Date();
        newItem.masteryLevel = 'New';
        
        // Check for duplicates
        const isDuplicate = libraryData.some(libItem => 
            (libItem.normalizedEnglish || '').toLowerCase().trim() === newItem.normalizedEnglish
        );
        if (isDuplicate) {
            return showMessageModal('Duplicate Item', 'An item with this English translation already exists in your library.');
        }

        const collectionRef = collection(db, `/artifacts/${APP_ID}/users/${currentUserId}/library`);
        try {
            await addDoc(collectionRef, newItem);
            showMessageModal('Success', 'Custom item added to your library.');
            hideModal('add-item-modal');
        } catch (error) {
            console.error("Error adding custom item:", error);
            showMessageModal('Error', 'Could not add item to library.');
        }
    }

    // =================================================================================
    // AI & OTHER FUNCTIONS
    // =================================================================================
    function handleSaveToLibrary() {
        if (!generatedContentCache || generatedContentCache.length === 0) return showMessageModal('No Content', 'There is no generated content to save.');
        
        const bodyHtml = `
            <p class="text-gray-700 mb-4">Please provide the following details to save these items:</p>
            <input type="text" id="batch-name-input" class="w-full p-2 border rounded-lg mb-4" placeholder="Enter Batch Name (e.g., 'Chapter 1 Verbs')">
            <select id="content-type-select" class="w-full p-2 border rounded-lg">
                <option value="vocabulary" selected>Vocabulary</option>
                <option value="dialogue">Sentence</option>
                <option value="grammar">Grammar</option>
            </select>`;

        showConfirmationModal(
            `Save to Library`,
            bodyHtml,
            (modalData) => {
                if (modalData) {
                    addContentToFirestore(generatedContentCache, modalData.batchName, modalData.type);
                }
            }
        );
    }
    
    async function handleGenerateContent() {
        const prompt = document.getElementById('prompt-input').value;
        if (!prompt) return showMessageModal('Input Required', 'Please enter a prompt.');
        
        const basePrompt = `You are an expert in conversational Hyderabadi Urdu for home and family use. Your task is to generate learning materials for an American English speaker.

        **Perfect Example of a single JSON object:**
        {
          "englishTranslation": "My name is...",
          "urduScriptTransliteration": "میرا نام... ہے (Mera naam... hai)",
          "phoneticHints": "Mera: 'Me' like in 'met'. 'Ra' is a soft, tapped 'r' sound, similar to the 'tt' in the American English word 'butter'. Naam: long 'aa' sound like 'a' in 'father'.",
          "grammarNotes": "Uses the possessive 'Mera' (my). The verb 'hai' (is) comes at the end of the sentence.",
          "contextualUsageNotes": "This is a standard, polite way to introduce yourself in most situations."
        }

        **Crucial Constraints for Notes (Follow these exactly):**
        - Your entire response MUST be a valid JSON array of objects.
        - **Phonetic Hints:** Be extremely precise. Describe tongue/lip position, aspiration (a puff of air), and compare to specific sounds in American English, French, or Spanish if helpful. Focus on sounds that are difficult for English speakers.
        - **Other Notes:** Be brief and to the point.
        - If a note field is not applicable, return an empty string "".
        - DO NOT give advice, disclaimers, or mention native speakers.

        Now, fulfill the following user request:`;
        
        const schema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    "englishTranslation": { "type": "STRING" },
                    "urduScriptTransliteration": { "type": "STRING" },
                    "phoneticHints": { "type": "STRING" },
                    "grammarNotes": { "type": "STRING" },
                    "contextualUsageNotes": { "type": "STRING" }
                },
                required: ["englishTranslation", "urduScriptTransliteration"]
            }
        };

        const fullPrompt = `${basePrompt}\n\nUser Request: "${prompt}"`;
        const result = await callGeminiAPI(fullPrompt, schema);

        if (result) {
            generatedContentCache = Array.isArray(result) ? result : [];
            document.getElementById('generation-output').innerHTML = formatGeneratedContentForDisplay(generatedContentCache);
            document.getElementById('generation-output').classList.remove('hidden');
            document.getElementById('generation-actions').classList.remove('hidden');
        }
    }

    function formatGeneratedContentForDisplay(content) {
        if (!Array.isArray(content) || content.length === 0) {
            return `<p class="text-gray-700">The AI did not return any valid content. Please try a different prompt.</p>`;
        }
        return content.map((item) => `
            <div class="mb-4 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h4 class="font-bold text-lg text-teal-700">${item.englishTranslation}</h4>
                <p class="urdu-text text-xl font-semibold">${item.urduScriptTransliteration}</p>
                ${item.phoneticHints ? `<p class="mt-2 text-sm"><strong class="font-semibold">Phonetics:</strong> ${item.phoneticHints}</p>` : ''}
                ${item.grammarNotes ? `<p class="mt-2 text-sm"><strong class="font-semibold">Grammar:</strong> ${item.grammarNotes}</p>` : ''}
                ${item.contextualUsageNotes ? `<p class="mt-2 text-sm"><strong class="font-semibold">Context:</strong> ${item.contextualUsageNotes}</p>` : ''}
            </div>
        `).join('');
    }
    
    async function callGeminiAPI(prompt, schema) {
        document.getElementById('generation-loading').classList.remove('hidden');
        document.getElementById('generation-output').classList.add('hidden');
        document.getElementById('generation-actions').classList.add('hidden');
        
        try {
            // The key for the Gemini API call.
            const apiKey = "AIzaSyByUcH76A__WLT4lqPfTSW4M0QQidHQTYE";

            if (!apiKey) {
                throw new Error("API Key is not configured. Please add your Gemini API key to the callGeminiAPI function in the script.");
            }

            const payload = { 
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json", responseSchema: schema }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                // Provide a more specific error message if the key is invalid
                if (response.status === 400 && errorBody.error?.message.includes('API key not valid')) {
                     throw new Error(`API Error: The provided API key is not valid. Please check your key and try again.`);
                }
                throw new Error(`API Error: ${errorBody.error?.message || 'Unknown error'}`);
            }

            const result = await response.json();
            const rawTextResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!rawTextResponse) throw new Error("The AI returned an empty or malformed response.");
            
            return JSON.parse(rawTextResponse);

        } catch (error) {
            console.error("Gemini API call failed:", error);
            showMessageModal('Generation Failed', `An error occurred: ${error.message}. Please check the console for details.`);
            return null;
        } finally {
            document.getElementById('generation-loading').classList.add('hidden');
        }
    }

    async function handleImFeelingLucky() {
        const existingContentSummary = `The user already has the following items in their library:
            - Vocabulary: ${libraryData.filter(i => i.type === 'vocabulary').slice(0, 10).map(item => item.englishTranslation).join(', ')}
            - Dialogues: ${libraryData.filter(i => i.type === 'dialogue').slice(0, 10).map(item => item.englishTranslation).join(', ')}`;
        
        const prompt = `Based on the user's existing learning library, suggest 3 new, specific, and actionable content ideas for conversational Hyderabadi Urdu. The user wants to learn to speak with family. The ideas should be distinct from the existing content. Return the suggestions as a simple JSON array of strings.
        
        ${existingContentSummary}
        
        Example response: ["10 phrases for praising a child's effort", "Vocabulary for different types of weather", "How to ask 'what happened?' in 3 different ways"]`;

        const schema = { type: "ARRAY", items: { "type": "STRING" } };
        const ideas = await callGeminiAPI(prompt, schema);

        if (ideas && Array.isArray(ideas)) {
            document.getElementById('generation-output').innerHTML = `
                <h4 class="font-semibold mb-2 text-lg text-teal-700">Here are some ideas for you:</h4>
                <ul class="list-disc list-inside space-y-2 text-gray-800">
                    ${ideas.map(idea => `<li>${idea}</li>`).join('')}
                </ul>
                <p class="mt-4 text-sm text-gray-600">Copy an idea into the prompt box above and click 'Generate'!</p>`;
            document.getElementById('generation-output').classList.remove('hidden');
            document.getElementById('generation-actions').classList.add('hidden');
        }
    }
    
    function exportLibraryToQuizlet() {
        const selectedCheckboxes = document.querySelectorAll('.item-select-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            return showMessageModal('No Selection', 'Please check the items you want to export from the library.');
        }
        let itemsToExport = Array.from(selectedCheckboxes)
            .map(cb => libraryData.find(item => item.id === cb.dataset.id))
            .filter(Boolean); // Filter out any potential undefined items

        exportToQuizlet(itemsToExport);
    }
    
    function exportGeneratedToQuizlet() {
        if (!generatedContentCache || generatedContentCache.length === 0) {
            return showMessageModal('No Content', 'Please generate some content first to export it.');
        }
        exportToQuizlet(generatedContentCache);
    }

    function exportToQuizlet(items) {
        const exportString = items.map(item => {
            const term = item.englishTranslation || '';
            const definitionParts = [
                `${item.urduScriptTransliteration || ''}`,
                item.phoneticHints ? `Phonetics: ${item.phoneticHints}` : null,
                item.grammarNotes ? `Grammar: ${item.grammarNotes}` : null,
                item.contextualUsageNotes ? `Notes: ${item.contextualUsageNotes}` : null,
                // Combine notes if they exist from custom add
                item.notes ? `Notes: ${item.notes}`: null
            ];
            const definition = definitionParts.filter(Boolean).join(' // ').replace(/\n/g, ' ');
            return `${term} | ${definition}`;
        }).join('\n');

        const textarea = document.createElement('textarea');
        textarea.value = exportString;
        textarea.style.position = 'fixed'; // Prevent screen jump
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            showMessageModal('Export Successful', 'Content copied to clipboard! You can now paste it into Quizlet.');
        } catch (err) {
            showMessageModal('Export Error', 'Failed to copy to clipboard. Please try again.');
        }
        document.body.removeChild(textarea);
    }

</script>
</body>
</html>
