<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyderabadi Urdu Learning Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chosen Palette: "Warm Neutral Harmony" -->
    <!-- Application Structure Plan: A task-oriented, single-page application design with a fixed sidebar for primary navigation and a main content area that dynamically displays different views. The structure is designed to follow the user's core workflow: 1) Dashboard (Home) for a quick overview of progress. 2) Generate Content for AI-powered creation. 3) My Library (with tabs for Vocabulary, Dialogues, Grammar) for curation, editing, and practice. 4) A dedicated Flashcard mode. This non-linear, task-based architecture was chosen over a report-like structure to give the user immediate access to the tools they need most, enhancing usability and efficiency for a busy learner. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Learning Progress (Mastery Levels). Goal: Inform. Viz: Donut Chart (Chart.js). Interaction: Hover for details. Justification: Provides an immediate, easy-to-digest visual summary of the user's overall progress.
        - Report Info: Content totals (Vocab, Dialogues, etc.). Goal: Compare. Viz: Bar Chart (Chart.js). Interaction: Hover for exact counts. Justification: Quickly communicates the volume of content in each learning module.
        - Report Info: Vocabulary, Dialogues, Grammar Libraries. Goal: Organize & Inform. Viz: Interactive HTML Tables. Interaction: Filtering by batch/mastery, inline editing, mastery updates, selection for export. Justification: This is the core "workbench" feature. A table provides a dense, scannable view, and the interactions support the primary curation workflow.
        - Report Info: Vocabulary Practice. Goal: Practice/Recall. Viz: HTML/CSS Flashcard Modal. Interaction: Click to flip, next/prev navigation, shuffle. Justification: Provides a simple, effective in-app practice session without the need to immediately export to Quizlet.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-icon { font-size: 1.25rem; }
        .active-nav { background-color: #E5E7EB; color: #1F2937; }
        .urdu-text { font-family: 'Noto Nastaliq Urdu', serif; font-size: 1.2rem; }
        .modal { display: none; }
        .flashcard-container { perspective: 1000px; }
        .flashcard { transform-style: preserve-3d; transition: transform 0.6s; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .flashcard-back { transform: rotateY(180deg); }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Max width for charts */
            margin-left: auto;
            margin-right: auto;
            height: 300px; /* Base height */
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="flex h-screen">
        <!-- Sidebar Navigation -->
        <aside class="w-20 md:w-64 bg-white border-r flex flex-col">
            <div class="h-16 flex items-center justify-center border-b">
                <i class="fas fa-book-open-reader text-2xl text-teal-600"></i>
                <span class="hidden md:inline ml-3 text-lg font-bold">Urdu Assistant</span>
            </div>
            <nav class="flex-1 px-2 md:px-4 py-4 space-y-2">
                <a href="#dashboard" class="flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-100 nav-link active-nav">
                    <i class="fas fa-chart-pie sidebar-icon"></i>
                    <span class="hidden md:inline ml-4 font-medium">Dashboard</span>
                </a>
                <a href="#generate" class="flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-100 nav-link">
                    <i class="fas fa-magic-sparkles sidebar-icon"></i>
                    <span class="hidden md:inline ml-4 font-medium">Generate Content</span>
                </a>
                <a href="#library" class="flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-100 nav-link">
                    <i class="fas fa-layer-group sidebar-icon"></i>
                    <span class="hidden md:inline ml-4 font-medium">My Library</span>
                </a>
            </nav>
            <div class="px-2 md:px-4 py-4 border-t">
                 <div id="auth-container" class="space-y-2">
                     <!-- Auth content will be injected here -->
                 </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            
            <!-- Dashboard View -->
            <div id="dashboard" class="page-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Dashboard</h1>
                <p class="text-gray-600 mb-8">Welcome back! Here's a snapshot of your learning journey.</p>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-lg font-semibold mb-4">Total Items in Library</h3>
                        <div class="chart-container h-64 md:h-80"><canvas id="progressChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                         <h3 class="text-lg font-semibold mb-4">Mastery Levels</h3>
                         <div class="chart-container h-64 md:h-80"><canvas id="masteryChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Generate Content View -->
            <div id="generate" class="page-content hidden">
                 <h1 class="text-3xl font-bold text-gray-800 mb-2">Generate New Content</h1>
                 <p class="text-gray-600 mb-8">Use the power of AI to create custom learning materials. Describe what you need below.</p>
                 <div class="bg-white p-6 rounded-xl shadow-sm">
                    <textarea id="prompt-input" rows="5" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., 'Give me 10 words about kitchen items with phonetic notes' or 'Provide 5 sentences for talking to a child about bedtime.'"></textarea>
                    <div class="flex flex-wrap items-center justify-between mt-4 gap-4">
                        <button id="generate-btn" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-700 transition-colors">
                            <i class="fas fa-magic-sparkles mr-2"></i>Generate
                        </button>
                         <button id="lucky-btn" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                            <i class="fas fa-dice mr-2"></i>I'm Feeling Lucky
                        </button>
                    </div>
                    <div id="generation-output" class="mt-6 p-4 border-l-4 border-teal-500 bg-teal-50 hidden"></div>
                    <div id="generation-loading" class="mt-6 hidden flex items-center justify-center">
                        <i class="fas fa-spinner fa-spin text-teal-600 text-3xl"></i>
                        <span class="ml-3 text-gray-600">Generating content...</span>
                    </div>
                    <div id="generation-actions" class="mt-4 flex flex-wrap gap-2 hidden">
                        <button id="load-vocab-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">Load to Vocabulary</button>
                        <button id="load-dialogues-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">Load to Dialogues</button>
                        <button id="load-grammar-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">Load to Grammar</button>
                    </div>
                 </div>
            </div>

            <!-- Library View -->
            <div id="library" class="page-content hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">My Library</h1>
                <p class="text-gray-600 mb-6">Curate, practice, and export your personalized learning sets.</p>
                
                <!-- Library Tabs -->
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button class="library-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-teal-500 text-teal-600" data-tab="vocabulary">Vocabulary</button>
                        <button class="library-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="dialogues">Dialogues</button>
                        <button class="library-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="grammar">Grammar Examples</button>
                    </nav>
                </div>
                
                <div id="library-content-area" class="mt-6">
                    <!-- Tab Content will be injected here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="auth-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md relative">
            <h2 class="text-2xl font-bold mb-6 text-center">Sign In / Sign Up</h2>
            <input type="email" id="email-input" placeholder="Email" class="w-full p-3 mb-4 border rounded-lg">
            <input type="password" id="password-input" placeholder="Password" class="w-full p-3 mb-4 border rounded-lg">
            <div class="flex gap-4">
                <button id="signin-btn" class="flex-1 bg-teal-600 text-white py-2 rounded-lg font-semibold hover:bg-teal-700">Sign In</button>
                <button id="signup-btn" class="flex-1 bg-gray-600 text-white py-2 rounded-lg font-semibold hover:bg-gray-700">Sign Up</button>
            </div>
            <button id="close-auth-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
    </div>
    
    <div id="flashcard-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="w-full max-w-2xl relative">
            <div class="flashcard-container h-80">
                <div id="flashcard-inner" class="flashcard relative w-full h-full">
                    <div id="flashcard-front" class="flashcard-face absolute w-full h-full bg-white rounded-xl shadow-2xl flex flex-col items-center justify-center p-6 text-center"></div>
                    <div id="flashcard-back" class="flashcard-face flashcard-back absolute w-full h-full bg-white rounded-xl shadow-2xl flex flex-col items-center justify-center p-6 text-center"></div>
                </div>
            </div>
            <div class="flex items-center justify-center mt-6 gap-4">
                 <button id="flashcard-prev" class="bg-white p-3 rounded-full shadow-lg hover:bg-gray-200"><i class="fas fa-arrow-left"></i></button>
                 <button id="flashcard-shuffle" class="bg-white text-teal-600 px-6 py-3 rounded-full shadow-lg font-semibold hover:bg-gray-200"><i class="fas fa-random mr-2"></i>Shuffle</button>
                 <button id="flashcard-next" class="bg-white p-3 rounded-full shadow-lg hover:bg-gray-200"><i class="fas fa-arrow-right"></i></button>
            </div>
            <button id="close-flashcard-modal" class="absolute top-4 right-4 text-white hover:text-gray-300 text-3xl">&times;</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm text-center relative">
            <h2 id="confirmation-title" class="text-xl font-bold mb-4"></h2>
            <p id="confirmation-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-700">Yes</button>
                <button id="confirm-no" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-400">No</button>
            </div>
            <button id="close-confirmation-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm text-center relative">
            <h2 id="message-title" class="text-xl font-bold mb-4"></h2>
            <p id="message-content" class="text-gray-700 mb-6"></p>
            <button id="close-message-modal" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-700">OK</button>
            <button id="close-message-modal-x" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let app;
    let db;
    let auth;
    let currentUserId = null;
    let isAuthReady = false;

    // --- GLOBAL DATA STORES ---
    let vocabularyData = [];
    let dialoguesData = [];
    let grammarData = [];
    let generatedContentCache = []; // To store content generated by AI before saving to Firestore

    // --- CHART CONFIG ---
    let progressChartInstance, masteryChartInstance;
    const chartColors = {
        'Never Seen': '#9CA3AF',
        'Recognized': '#A78BFA',
        'Familiar': '#60A5FA',
        'Can Recall': '#34D399',
        'Mastered': '#14B8A6',
        'Teaching Ready': '#F59E0B'
    };
    const masteryLevels = Object.keys(chartColors);

    function createProgressChart() {
        const ctx = document.getElementById('progressChart').getContext('2d');
        if (progressChartInstance) progressChartInstance.destroy();
        progressChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Vocabulary', 'Dialogues', 'Grammar'],
                datasets: [{
                    label: 'Total Items',
                    data: [vocabularyData.length, dialoguesData.length, grammarData.length],
                    backgroundColor: ['#14B8A6', '#F59E0B', '#EF4444'],
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    function createMasteryChart() {
        const ctx = document.getElementById('masteryChart').getContext('2d');
        const masteryCounts = vocabularyData.reduce((acc, item) => {
            acc[item.masteryLevel] = (acc[item.masteryLevel] || 0) + 1;
            return acc;
        }, {});

        const labels = Object.keys(masteryCounts);
        const data = Object.values(masteryCounts);
        const backgroundColors = labels.map(label => chartColors[label] || '#CBD5E1');

        if (masteryChartInstance) masteryChartInstance.destroy();
        masteryChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15 }
                    }
                }
            }
        });
    }

    // --- NAVIGATION & PAGE DISPLAY ---
    const navLinks = document.querySelectorAll('.nav-link');
    const pages = document.querySelectorAll('.page-content');

    function showPage(pageId) {
        pages.forEach(page => page.classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');

        navLinks.forEach(link => {
            if (link.getAttribute('href') === `#${pageId}`) {
                link.classList.add('active-nav');
            } else {
                link.classList.remove('active-nav');
            }
        });
        
        if (pageId === 'dashboard' && isAuthReady) {
            createProgressChart();
            createMasteryChart();
        }
        if(pageId === 'library' && isAuthReady) {
            handleTabClick(document.querySelector('.library-tab'));
        }
    }

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const pageId = e.currentTarget.getAttribute('href').substring(1);
            showPage(pageId);
        });
    });

    // --- LIBRARY TABS & CONTENT RENDERING ---
    const libraryTabs = document.querySelectorAll('.library-tab');
    const libraryContentArea = document.getElementById('library-content-area');

    function handleTabClick(targetTab) {
        libraryTabs.forEach(t => {
            t.classList.remove('border-teal-500', 'text-teal-600');
            t.classList.add('border-transparent', 'text-gray-500');
        });
        targetTab.classList.add('border-teal-500', 'text-teal-600');
        targetTab.classList.remove('border-transparent', 'text-gray-500');

        renderLibraryContent(targetTab.dataset.tab);
    }
    
    libraryTabs.forEach(tab => tab.addEventListener('click', e => handleTabClick(e.target)));

    async function renderLibraryContent(tab) {
        let data, tableHeaders;
        let collectionName;

        if (tab === 'vocabulary') {
            data = vocabularyData;
            tableHeaders = ['English', 'Urdu', 'Phonetics', 'Notes', 'Batch', 'Mastery', 'Actions'];
            collectionName = 'vocabulary';
        } else if (tab === 'dialogues') {
            data = dialoguesData;
            tableHeaders = ['English', 'Urdu', 'Phonetics', 'Grammar', 'Notes', 'Batch', 'Mastery', 'Actions'];
            collectionName = 'dialogues';
        } else if (tab === 'grammar') {
            data = grammarData;
            tableHeaders = ['English', 'Urdu', 'Phonetics', 'Grammar', 'Notes', 'Batch', 'Mastery', 'Actions'];
            collectionName = 'grammarExamples';
        } else {
            data = [];
            tableHeaders = [];
        }

        libraryContentArea.innerHTML = `
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <div class="flex flex-wrap gap-4 mb-4">
                    <!-- Filter controls here (to be implemented later) -->
                </div>
                <div class="flex flex-wrap gap-4 mb-4 items-center">
                    <button id="export-quizlet-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 text-sm"><i class="fas fa-file-export mr-2"></i>Export to Quizlet</button>
                    ${tab === 'vocabulary' ? `<button id="start-flashcards" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 text-sm"><i class="far fa-clone mr-2"></i>Practice with Flashcards</button>` : ''}
                    <button id="add-custom-item-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 text-sm"><i class="fas fa-plus mr-2"></i>Add Custom Item</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3"><input type="checkbox" id="select-all-items"></th>
                                ${tableHeaders.map(h => `<th scope="col" class="px-6 py-3">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(item => `
                                <tr class="bg-white border-b hover:bg-gray-50" data-id="${item.id}" data-collection="${collectionName}">
                                    <td class="px-6 py-4"><input type="checkbox" class="item-select-checkbox"></td>
                                    <td class="px-6 py-4" contenteditable="true" data-field="englishTranslation">${item.englishTranslation}</td>
                                    <td class="px-6 py-4 urdu-text" contenteditable="true" data-field="urduScriptTransliteration">${item.urduScriptTransliteration}</td>
                                    <td class="px-6 py-4" contenteditable="true" data-field="phoneticHints">${item.phoneticHints}</td>
                                    ${tab !== 'vocabulary' ? `<td class="px-6 py-4" contenteditable="true" data-field="grammarNotes">${item.grammarNotes || ''}</td>` : ''}
                                    <td class="px-6 py-4" contenteditable="true" data-field="contextualUsageNotes">${item.contextualUsageNotes || ''}</td>
                                    <td class="px-6 py-4" contenteditable="true" data-field="batchName">${item.batchName}</td>
                                    <td class="px-6 py-4">
                                        <select class="mastery-select border rounded-lg p-1" data-id="${item.id}" data-collection="${collectionName}">
                                            ${masteryLevels.map(level => `<option value="${level}" ${item.masteryLevel === level ? 'selected' : ''}>${level}</option>`).join('')}
                                        </select>
                                    </td>
                                    <td class="px-6 py-4">
                                        <button class="delete-item-btn text-red-500 hover:text-red-700" data-id="${item.id}" data-collection="${collectionName}"><i class="fas fa-trash-alt"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                            ${data.length === 0 ? `<tr><td colspan="${tableHeaders.length + 1}" class="text-center py-8">No items in this library yet.</td></tr>` : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        document.getElementById('select-all-items').addEventListener('change', (e) => {
            document.querySelectorAll('.item-select-checkbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        document.querySelectorAll('.mastery-select').forEach(select => {
            select.addEventListener('change', async (e) => {
                const itemId = e.target.dataset.id;
                const itemCollection = e.target.dataset.collection;
                const newMasteryLevel = e.target.value;
                await updateItemMastery(itemCollection, itemId, newMasteryLevel);
            });
        });

        document.querySelectorAll('[contenteditable="true"]').forEach(cell => {
            cell.addEventListener('blur', async (e) => {
                const row = e.target.closest('tr');
                const itemId = row.dataset.id;
                const itemCollection = row.dataset.collection;
                const field = e.target.dataset.field;
                const newValue = e.target.innerText;
                await updateItemField(itemCollection, itemId, field, newValue);
            });
        });

        document.querySelectorAll('.delete-item-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const itemId = e.currentTarget.dataset.id;
                const itemCollection = e.currentTarget.dataset.collection;
                showConfirmationModal('Delete Item', 'Are you sure you want to delete this item?', async () => {
                    await deleteItem(itemCollection, itemId);
                });
            });
        });

        const startFlashcardsBtn = document.getElementById('start-flashcards');
        if(startFlashcardsBtn) {
            startFlashcardsBtn.addEventListener('click', () => showFlashcardModal());
        }

        document.getElementById('export-quizlet-btn').addEventListener('click', () => exportToQuizlet(tab));
        document.getElementById('add-custom-item-btn').addEventListener('click', () => showMessageModal('Add Custom Item', 'This feature is coming soon!', 'OK')); // Placeholder
    }

    // --- FLASHCARD MODAL ---
    const flashcardModal = document.getElementById('flashcard-modal');
    const flashcardInner = document.getElementById('flashcard-inner');
    const flashcardFront = document.getElementById('flashcard-front');
    const flashcardBack = document.getElementById('flashcard-back');
    
    let currentFlashcardIndex = 0;
    let shuffledIndices = [];

    function showFlashcardModal() {
        if(vocabularyData.length === 0) {
            showMessageModal('No Vocabulary', 'Please add some vocabulary items to practice flashcards.', 'OK');
            return;
        }
        shuffledIndices = vocabularyData.map((_, i) => i);
        currentFlashcardIndex = 0;
        updateFlashcard();
        flashcardModal.style.display = 'flex';
    }
    
    function updateFlashcard(isShuffle = false) {
        if(isShuffle) {
             for (let i = shuffledIndices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledIndices[i], shuffledIndices[j]] = [shuffledIndices[j], shuffledIndices[i]];
            }
            currentFlashcardIndex = 0;
        }

        const item = vocabularyData[shuffledIndices[currentFlashcardIndex]];
        flashcardFront.innerHTML = `<h2 class="text-4xl font-bold">${item.englishTranslation}</h2>`;
        flashcardBack.innerHTML = `
            <div>
                <h3 class="text-3xl font-bold mb-4 urdu-text">${item.urduScriptTransliteration}</h3>
                <p class="text-gray-600"><strong>Phonetics:</strong> ${item.phoneticHints}</p>
                <p class="text-gray-600 mt-2"><strong>Notes:</strong> ${item.contextualUsageNotes}</p>
            </div>`;
        flashcardInner.classList.remove('is-flipped');
    }
    
    document.getElementById('flashcard-next').addEventListener('click', () => {
        currentFlashcardIndex = (currentFlashcardIndex + 1) % vocabularyData.length;
        updateFlashcard();
    });
    
    document.getElementById('flashcard-prev').addEventListener('click', () => {
        currentFlashcardIndex = (currentFlashcardIndex - 1 + vocabularyData.length) % vocabularyData.length;
        updateFlashcard();
    });
    
    document.getElementById('flashcard-shuffle').addEventListener('click', () => {
        updateFlashcard(true);
    });

    flashcardInner.addEventListener('click', () => flashcardInner.classList.toggle('is-flipped'));
    document.getElementById('close-flashcard-modal').addEventListener('click', () => flashcardModal.style.display = 'none');

    // --- AUTHENTICATION ---
    const authContainer = document.getElementById('auth-container');
    const authModal = document.getElementById('auth-modal');

    function renderAuthUI() {
        if (currentUserId) {
            authContainer.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-user-circle text-2xl text-gray-500"></i>
                    <span class="hidden md:inline ml-3 text-sm font-medium">${auth.currentUser?.email || 'Anonymous'}</span>
                </div>
                <div class="flex items-center mt-2">
                    <i class="fas fa-id-badge text-2xl text-gray-500"></i>
                    <span class="hidden md:inline ml-3 text-xs font-medium break-all">${currentUserId}</span>
                </div>
                <button id="signout-btn" class="w-full mt-2 text-left flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-100">
                    <i class="fas fa-sign-out-alt sidebar-icon"></i>
                    <span class="hidden md:inline ml-4 font-medium">Sign Out</span>
                </button>
            `;
            document.getElementById('signout-btn').addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    showMessageModal('Signed Out', 'You have been signed out. You are now signed in anonymously.', 'OK');
                } catch (error) {
                    showMessageModal('Sign Out Error', `Error signing out: ${error.message}`, 'OK');
                }
            });
        } else {
            authContainer.innerHTML = `
                <button id="open-auth-modal-btn" class="w-full text-left flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-100">
                     <i class="fas fa-sign-in-alt sidebar-icon"></i>
                     <span class="hidden md:inline ml-4 font-medium">Sign In / Sign Up</span>
                </button>
            `;
            document.getElementById('open-auth-modal-btn').addEventListener('click', () => {
                authModal.style.display = 'flex';
            });
        }
    }
    
    document.getElementById('close-auth-modal').addEventListener('click', () => authModal.style.display = 'none');
    document.getElementById('signin-btn').addEventListener('click', async () => {
        const email = document.getElementById('email-input').value;
        const password = document.getElementById('password-input').value;
        if (!email || !password) {
            showMessageModal('Input Error', 'Please enter both email and password.', 'OK');
            return;
        }
        try {
            await signInWithEmailAndPassword(auth, email, password);
            authModal.style.display = 'none';
            showMessageModal('Signed In', 'You have successfully signed in!', 'OK');
        } catch (error) {
            showMessageModal('Sign In Error', `Error signing in: ${error.message}`, 'OK');
        }
    });

    document.getElementById('signup-btn').addEventListener('click', async () => {
        const email = document.getElementById('email-input').value;
        const password = document.getElementById('password-input').value;
        if (!email || !password) {
            showMessageModal('Input Error', 'Please enter both email and password.', 'OK');
            return;
        }
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            authModal.style.display = 'none';
            showMessageModal('Signed Up', 'Account created successfully! You are now signed in.', 'OK');
        } catch (error) {
            showMessageModal('Sign Up Error', `Error creating account: ${error.message}`, 'OK');
        }
    });

    // --- FIREBASE INITIALIZATION & DATA FETCHING ---
    async function initializeFirebase() {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
            } else {
                // If no user is logged in, sign in anonymously
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Error signing in anonymously:", error);
                    showMessageModal('Authentication Error', `Failed to sign in anonymously: ${error.message}`, 'OK');
                }
            }
            isAuthReady = true;
            renderAuthUI();
            if (currentUserId) {
                setupFirestoreListeners();
            }
            // Ensure the current page is rendered after auth is ready
            const currentPageId = document.querySelector('.nav-link.active-nav').getAttribute('href').substring(1);
            showPage(currentPageId);
        });

        // Use __initial_auth_token if available
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            try {
                await signInWithCustomToken(auth, __initial_auth_token);
            } catch (error) {
                console.error("Error signing in with custom token:", error);
                showMessageModal('Authentication Error', `Failed to sign in with custom token: ${error.message}`, 'OK');
                // Fallback to anonymous if custom token fails
                await signInAnonymously(auth);
            }
        } else {
            // If no initial token, proceed with anonymous sign-in via onAuthStateChanged
        }
    }

    function setupFirestoreListeners() {
        if (!db || !currentUserId) return;

        const getCollectionPath = (collectionName) => `/artifacts/${__app_id}/users/${currentUserId}/${collectionName}`;

        onSnapshot(collection(db, getCollectionPath('vocabulary')), (snapshot) => {
            vocabularyData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (document.querySelector('.library-tab[data-tab="vocabulary"]').classList.contains('border-teal-500')) {
                renderLibraryContent('vocabulary');
            }
            if (document.getElementById('dashboard').classList.contains('hidden') === false) {
                 createProgressChart();
                 createMasteryChart();
            }
        });

        onSnapshot(collection(db, getCollectionPath('dialogues')), (snapshot) => {
            dialoguesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (document.querySelector('.library-tab[data-tab="dialogues"]').classList.contains('border-teal-500')) {
                renderLibraryContent('dialogues');
            }
            if (document.getElementById('dashboard').classList.contains('hidden') === false) {
                 createProgressChart();
            }
        });

        onSnapshot(collection(db, getCollectionPath('grammarExamples')), (snapshot) => {
            grammarData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (document.querySelector('.library-tab[data-tab="grammar"]').classList.contains('border-teal-500')) {
                renderLibraryContent('grammar');
            }
            if (document.getElementById('dashboard').classList.contains('hidden') === false) {
                 createProgressChart();
            }
        });
    }

    async function updateItemMastery(collectionName, itemId, newMasteryLevel) {
        try {
            const itemRef = doc(db, `/artifacts/${__app_id}/users/${currentUserId}/${collectionName}`, itemId);
            await updateDoc(itemRef, { masteryLevel: newMasteryLevel, lastReviewed: new Date() });
            showMessageModal('Success', 'Mastery level updated!', 'OK');
        } catch (error) {
            showMessageModal('Error', `Failed to update mastery level: ${error.message}`, 'OK');
        }
    }

    async function updateItemField(collectionName, itemId, field, newValue) {
        try {
            const itemRef = doc(db, `/artifacts/${__app_id}/users/${currentUserId}/${collectionName}`, itemId);
            await updateDoc(itemRef, { [field]: newValue });
            showMessageModal('Success', 'Item updated!', 'OK');
        } catch (error) {
            showMessageModal('Error', `Failed to update item: ${error.message}`, 'OK');
        }
    }

    async function deleteItem(collectionName, itemId) {
        try {
            const itemRef = doc(db, `/artifacts/${__app_id}/users/${currentUserId}/${collectionName}`, itemId);
            await deleteDoc(itemRef);
            showMessageModal('Success', 'Item deleted!', 'OK');
        } catch (error) {
            showMessageModal('Error', `Failed to delete item: ${error.message}`, 'OK');
        }
    }

    async function addGeneratedContentToFirestore(contentArray, collectionName, batchName) {
        if (!currentUserId) {
            showMessageModal('Error', 'User not authenticated. Please sign in.', 'OK');
            return;
        }

        const collectionRef = collection(db, `/artifacts/${__app_id}/users/${currentUserId}/${collectionName}`);
        let addedCount = 0;
        let skippedCount = 0;

        for (const item of contentArray) {
            const querySnapshot = await getDocs(query(
                collectionRef,
                where('englishTranslation', '==', item.englishTranslation),
                where('urduScriptTransliteration', '==', item.urduScriptTransliteration)
            ));

            if (querySnapshot.empty) {
                const newItem = {
                    ...item,
                    batchName: batchName,
                    masteryLevel: 'Never Seen',
                    createdAt: new Date(),
                    lastReviewed: new Date(),
                    difficultyScore: 1, // Default
                    isAuthentic: false, // Default
                    needsAudio: true // Default
                };
                await addDoc(collectionRef, newItem);
                addedCount++;
            } else {
                skippedCount++;
            }
        }
        showMessageModal('Content Loaded', `Added ${addedCount} new items. Skipped ${skippedCount} duplicates.`, 'OK');
        document.getElementById('generation-output').classList.add('hidden');
        document.getElementById('generation-actions').classList.add('hidden');
    }

    // --- AI CONTENT GENERATION ---
    const generateBtn = document.getElementById('generate-btn');
    const luckyBtn = document.getElementById('lucky-btn');
    const promptInput = document.getElementById('prompt-input');
    const generationOutput = document.getElementById('generation-output');
    const generationLoading = document.getElementById('generation-loading');
    const generationActions = document.getElementById('generation-actions');
    const loadVocabBtn = document.getElementById('load-vocab-btn');
    const loadDialoguesBtn = document.getElementById('load-dialogues-btn');
    const loadGrammarBtn = document.getElementById('load-grammar-btn');

    async function callGeminiAPI(prompt, schema = null) {
        generationLoading.classList.remove('hidden');
        generationOutput.classList.add('hidden');
        generationActions.classList.add('hidden');

        try {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            
            const payload = { contents: chatHistory };
            if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema
                };
            }

            const apiKey = ""; // Canvas will provide this at runtime
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                return schema ? JSON.parse(text) : text;
            } else {
                showMessageModal('Generation Error', 'Could not get a valid response from AI. Please try again.', 'OK');
                return null;
            }
        } catch (error) {
            showMessageModal('API Error', `Error calling Gemini API: ${error.message}`, 'OK');
            return null;
        } finally {
            generationLoading.classList.add('hidden');
        }
    }

    generateBtn.addEventListener('click', async () => {
        const prompt = promptInput.value;
        if (!prompt) {
            showMessageModal('Input Required', 'Please enter a prompt to generate content.', 'OK');
            return;
        }

        const basePrompt = `You are an expert in conversational Hyderabadi Urdu for home and family use. Prioritize less formal vocabulary where appropriate, but generate examples with formal sentence structures. Provide precise phonetic hints and concise grammar explanations for non-script learners. Avoid redundant phonetic descriptions. Based on the following request, generate content in JSON format.`;

        let schema;
        let inferredType = 'vocabulary'; // Default inference

        if (prompt.toLowerCase().includes('vocabulary') || prompt.toLowerCase().includes('words')) {
            schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "englishTranslation": { "type": "STRING" },
                        "urduScriptTransliteration": { "type": "STRING" },
                        "phoneticHints": { "type": "STRING" },
                        "contextualUsageNotes": { "type": "STRING" }
                    },
                    required: ["englishTranslation", "urduScriptTransliteration", "phoneticHints"]
                }
            };
            inferredType = 'vocabulary';
        } else if (prompt.toLowerCase().includes('sentence') || prompt.toLowerCase().includes('dialogue') || prompt.toLowerCase().includes('phrases')) {
            schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "englishTranslation": { "type": "STRING" },
                        "urduScriptTransliteration": { "type": "STRING" },
                        "phoneticHints": { "type": "STRING" },
                        "grammarNotes": { "type": "STRING" },
                        "contextualUsageNotes": { "type": "STRING" }
                    },
                    required: ["englishTranslation", "urduScriptTransliteration", "phoneticHints"]
                }
            };
            inferredType = 'dialogues'; // Could also be grammar, user will choose
        } else if (prompt.toLowerCase().includes('grammar') || prompt.toLowerCase().includes('rule') || prompt.toLowerCase().includes('conjugation')) {
            schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "englishTranslation": { "type": "STRING" },
                        "urduScriptTransliteration": { "type": "STRING" },
                        "phoneticHints": { "type": "STRING" },
                        "grammarNotes": { "type": "STRING" },
                        "contextualUsageNotes": { "type": "STRING" }
                    },
                    required: ["englishTranslation", "urduScriptTransliteration", "phoneticHints", "grammarNotes"]
                }
            };
            inferredType = 'grammarExamples';
        } else {
             // Fallback schema if type is unclear, let AI provide general text initially
             schema = null; // AI will return plain text
        }

        const fullPrompt = `${basePrompt}\n\nUser Request: ${prompt}`;
        const generatedContent = await callGeminiAPI(fullPrompt, schema);

        if (generatedContent) {
            generatedContentCache = generatedContent; // Store the raw generated content
            generationOutput.classList.remove('hidden');
            generationActions.classList.remove('hidden');
            
            // Display raw content for user review
            if (typeof generatedContent === 'string') {
                generationOutput.innerHTML = `<pre class="whitespace-pre-wrap">${generatedContent}</pre>`;
            } else {
                generationOutput.innerHTML = `<pre class="whitespace-pre-wrap">${JSON.stringify(generatedContent, null, 2)}</pre>`;
            }

            // Suggest loading based on inferred type
            loadVocabBtn.classList.add('hidden');
            loadDialoguesBtn.classList.add('hidden');
            loadGrammarBtn.classList.add('hidden');

            if (inferredType === 'vocabulary') loadVocabBtn.classList.remove('hidden');
            else if (inferredType === 'dialogues') loadDialoguesBtn.classList.remove('hidden');
            else if (inferredType === 'grammarExamples') loadGrammarBtn.classList.remove('hidden');
            else { // If inference was ambiguous, show all options
                loadVocabBtn.classList.remove('hidden');
                loadDialoguesBtn.classList.remove('hidden');
                loadGrammarBtn.classList.remove('hidden');
            }
        }
    });

    luckyBtn.addEventListener('click', async () => {
        const existingContent = {
            vocabulary: vocabularyData.map(item => item.englishTranslation),
            dialogues: dialoguesData.map(item => item.englishTranslation),
            grammarExamples: grammarData.map(item => item.englishTranslation)
        };
        const prompt = `Based on the user's existing learning library (Vocabulary: ${existingContent.vocabulary.join(', ')}, Dialogues: ${existingContent.dialogues.join(', ')}, Grammar Examples: ${existingContent.grammarExamples.join(', ')}), suggest 3 new content ideas for conversational Hyderabadi Urdu. Focus on topics that would naturally follow or expand on what they already know, or fill gaps. Provide only the suggestions as a JSON array of strings.`;
        
        const schema = {
            type: "ARRAY",
            items: { "type": "STRING" }
        };

        const ideas = await callGeminiAPI(prompt, schema);
        if (ideas && Array.isArray(ideas)) {
            generationOutput.classList.remove('hidden');
            generationActions.classList.add('hidden'); // No load buttons for ideas
            generationOutput.innerHTML = `
                <h4 class="font-semibold mb-2">Content Ideas for You:</h4>
                <ul class="list-disc list-inside">
                    ${ideas.map(idea => `<li>${idea}</li>`).join('')}
                </ul>
                <p class="mt-4 text-sm text-gray-600">Copy an idea into the prompt box and click 'Generate'!</p>
            `;
        }
    });

    loadVocabBtn.addEventListener('click', async () => {
        if (generatedContentCache.length === 0) {
            showMessageModal('No Content', 'No generated content to load.', 'OK');
            return;
        }
        showConfirmationModal('Load to Vocabulary', 'Enter a Batch Name for these vocabulary items:', async (batchName) => {
            if (batchName) {
                await addGeneratedContentToFirestore(generatedContentCache, 'vocabulary', batchName);
            } else {
                showMessageModal('Missing Input', 'Batch Name is required.', 'OK');
            }
        }, true); // Pass true for text input confirmation
    });

    loadDialoguesBtn.addEventListener('click', async () => {
        if (generatedContentCache.length === 0) {
            showMessageModal('No Content', 'No generated content to load.', 'OK');
            return;
        }
        showConfirmationModal('Load to Dialogues', 'Enter a Batch Name for these dialogues:', async (batchName) => {
            if (batchName) {
                await addGeneratedContentToFirestore(generatedContentCache, 'dialogues', batchName);
            } else {
                showMessageModal('Missing Input', 'Batch Name is required.', 'OK');
            }
        }, true);
    });

    loadGrammarBtn.addEventListener('click', async () => {
        if (generatedContentCache.length === 0) {
            showMessageModal('No Content', 'No generated content to load.', 'OK');
            return;
        }
        showConfirmationModal('Load to Grammar', 'Enter a Batch Name for these grammar examples:', async (batchName) => {
            if (batchName) {
                await addGeneratedContentToFirestore(generatedContentCache, 'grammarExamples', batchName);
            } else {
                showMessageModal('Missing Input', 'Batch Name is required.', 'OK');
            }
        }, true);
    });

    // --- QUIZLET EXPORT ---
    function exportToQuizlet(tab) {
        let itemsToExport = [];
        const checkboxes = document.querySelectorAll('.item-select-checkbox');
        const selectedCheckboxes = Array.from(checkboxes).filter(cb => cb.checked);

        if (selectedCheckboxes.length > 0) {
            itemsToExport = selectedCheckboxes.map(cb => {
                const row = cb.closest('tr');
                const itemId = row.dataset.id;
                let dataArray;
                if (tab === 'vocabulary') dataArray = vocabularyData;
                else if (tab === 'dialogues') dataArray = dialoguesData;
                else if (tab === 'grammar') dataArray = grammarData;
                return dataArray.find(item => item.id === itemId);
            }).filter(Boolean); // Remove any undefined if item not found
        } else {
            // If no items are checked, prompt to export all currently filtered items (not yet implemented filtering)
            // For now, it will export all items in the current tab's data
            showConfirmationModal('Export All?', `No specific items selected. Do you want to export all ${tab} items?`, () => {
                if (tab === 'vocabulary') itemsToExport = vocabularyData;
                else if (tab === 'dialogues') itemsToExport = dialoguesData;
                else if (tab === 'grammar') itemsToExport = grammarData;
                performQuizletExport(itemsToExport);
            });
            return; // Exit here, actual export happens in confirmation callback
        }
        performQuizletExport(itemsToExport);
    }

    function performQuizletExport(items) {
        if (items.length === 0) {
            showMessageModal('No Items', 'No items to export.', 'OK');
            return;
        }

        let exportString = items.map(item => {
            const english = item.englishTranslation || '';
            const urdu = item.urduScriptTransliteration || '';
            const phonetic = item.phoneticHints || '';
            const grammar = item.grammarNotes ? `// ${item.grammarNotes}` : '';
            const contextual = item.contextualUsageNotes ? `// ${item.contextualUsageNotes}` : '';

            // Replace internal newlines with // for Quizlet compatibility
            const definition = `${urdu} // ${phonetic} ${grammar} ${contextual}`.trim().replace(/\n/g, ' // ').replace(/\s\s+/g, ' ');

            return `${english} | ${definition}`;
        }).join('\n');

        try {
            const textarea = document.createElement('textarea');
            textarea.value = exportString;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showMessageModal('Export Successful', 'Content copied to clipboard! Go to Quizlet and use the "Import" feature.', 'OK');
        } catch (err) {
            showMessageModal('Export Error', 'Failed to copy to clipboard. Please try manually copying the content.', 'OK');
            console.error('Clipboard copy failed:', err);
        }
    }

    // --- CUSTOM MODALS (replacing alert/confirm) ---
    const confirmationModal = document.getElementById('confirmation-modal');
    const confirmationTitle = document.getElementById('confirmation-title');
    const confirmationMessage = document.getElementById('confirmation-message');
    const confirmYesBtn = document.getElementById('confirm-yes');
    const confirmNoBtn = document.getElementById('confirm-no');
    const closeConfirmationModalX = document.getElementById('close-confirmation-modal');

    const messageModal = document.getElementById('message-modal');
    const messageTitle = document.getElementById('message-title');
    const messageContent = document.getElementById('message-content');
    const closeMessageModalBtn = document.getElementById('close-message-modal');
    const closeMessageModalX = document.getElementById('close-message-modal-x');

    let confirmationCallback = null;
    let confirmationInput = null;

    function showConfirmationModal(title, message, callback, withInput = false) {
        confirmationTitle.innerText = title;
        confirmationMessage.innerText = message;
        confirmationCallback = callback;

        if (withInput) {
            confirmationInput = document.createElement('input');
            confirmationInput.type = 'text';
            confirmationInput.placeholder = 'Enter Batch Name';
            confirmationInput.className = 'w-full p-3 mb-4 border rounded-lg';
            confirmationMessage.parentNode.insertBefore(confirmationInput, confirmationMessage.nextSibling);
            confirmationInput.focus();
        } else {
            if (confirmationInput && confirmationInput.parentNode) {
                confirmationInput.parentNode.removeChild(confirmationInput);
                confirmationInput = null;
            }
        }

        confirmationModal.style.display = 'flex';
    }

    confirmYesBtn.addEventListener('click', () => {
        confirmationModal.style.display = 'none';
        if (confirmationCallback) {
            if (confirmationInput) {
                confirmationCallback(confirmationInput.value);
            } else {
                confirmationCallback(true);
            }
        }
        confirmationCallback = null;
        if (confirmationInput && confirmationInput.parentNode) {
            confirmationInput.parentNode.removeChild(confirmationInput);
            confirmationInput = null;
        }
    });

    confirmNoBtn.addEventListener('click', () => {
        confirmationModal.style.display = 'none';
        confirmationCallback = null;
        if (confirmationInput && confirmationInput.parentNode) {
            confirmationInput.parentNode.removeChild(confirmationInput);
            confirmationInput = null;
        }
    });

    closeConfirmationModalX.addEventListener('click', () => {
        confirmationModal.style.display = 'none';
        confirmationCallback = null;
        if (confirmationInput && confirmationInput.parentNode) {
            confirmationInput.parentNode.removeChild(confirmationInput);
            confirmationInput = null;
        }
    });

    function showMessageModal(title, message, buttonText) {
        messageTitle.innerText = title;
        messageContent.innerText = message;
        closeMessageModalBtn.innerText = buttonText;
        messageModal.style.display = 'flex';
    }

    closeMessageModalBtn.addEventListener('click', () => {
        messageModal.style.display = 'none';
    });
    closeMessageModalX.addEventListener('click', () => {
        messageModal.style.display = 'none';
    });

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', initializeFirebase);
</script>
</body>
</html>
